<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Locker Room Loyola Reflection</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animation for the listening button */
        .is-listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }
        /* Custom scrollbar */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        textarea::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        /* Hide the main app until JS compatibility check passes */
        #app-container {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Compatibility Error Message -->
    <div id="error-container" class="max-w-xl text-center p-8 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-red-400 mb-4">Browser Not Supported</h1>
        <p class="text-gray-300 text-lg">
            Sorry, this reflection tool requires the Chrome or Edge browser to use the Speech Recognition feature.
        </p>
        <p class="text-gray-400 mt-4">
            Please open this page in a compatible browser to continue.
        </p>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-3xl">
        <!-- This content will be dynamically generated by JavaScript -->
    </div>

    <script>
        // --- SPEECH AND SCRIPT DATA ---

        // The complete script, adapted for a guided audio experience.
        const script = [
            {
                title: "Welcome to the Locker Room Reflection",
                text: "Take a breath. This isn’t a test. There are no right or wrong answers. This is about you and how you see yourself—on the field and as a person. Answer honestly. You can record your answer by speaking. When you're ready, click 'Start Reflection' to begin." // Removed "I'll read out the prompts"
            },
            {
                title: "1. Identity and Self-Concept",
                text: "Tell me, in your own words: Who are you as a rugby player right now? Don’t talk about positions—describe your mindset, your habits, your identity. ... As you reflect, consider: What makes that identity important to you? When did you start seeing yourself that way? And do you feel this identity helps you... or holds you back?"
            },
            {
                title: "2. Values and Internal Standards",
                text: "What values do you bring to this program? Values that nobody has to coach you on, because they’re already part of who you are. ... Think about: How do you show that value on your best day? And what does it look like when that value gets challenged?"
            },
            {
                title: "3. Commitment and Accountability",
                text: "On a scale from 1 to 10, how committed are you to becoming the player you SAY you want to be? ... If you gave a high number, what does that level of commitment look like in your daily actions? What's one thing you could do to raise it by one point? ... If you gave a lower number, what’s holding that number down? What support or structure would help you level up?"
            },
            {
                title: "4. Strengths Discovery",
                text: "What is your undeniable strength as an athlete? Something that would make the team noticeably different if it disappeared. ... How did you develop that strength? And do you think your teammates see this strength in you?"
            },
            {
                title: "5. Shadow Side — Honest Weaknesses",
                text: "What is the part of your game—or your mindset—that you avoid talking about? The thing you know you need to handle, but you haven’t fully addressed yet. ... What’s the truth behind that? How does it show up during training or games? If you were given a plan to fix it, what would stop you from following it?"
            },
            {
                title: "6. Role Within the Program",
                text: "In this program, what do you believe your role is, beyond playing your position? ... Do you feel the team sees you the same way? What role do you WANT to grow into?"
            },
            {
                title: "7. Ownership",
                text: "When things go wrong—mistakes, losses, conflicts—how do you respond internally? Do you take ownership, deflect, get quiet, get frustrated? What’s your automatic response? ... Where do you think that response comes from? Is that response helping you become the player you want to be?"
            },
            {
                title: "8. Future Self — The Vision",
                text: "Picture yourself six months from now. What does the next-level version of you look and act like? On the field, in school, at home, and socially. ... What’s the biggest difference between that version of you and who you are today? What’s the first small step you can take tomorrow toward that version of yourself?"
            },
            {
                title: "9. Program Commitment",
                text: "What does this program mean to you? Not the scoreboard, not winning or losing... but to YOU. ... How has being part of this team changed you? What promise can you make to your teammates moving forward?"
            },
            {
                title: "10. Closing — Your Personal Statement",
                text: "If you had to leave one message for your future self—the version of you who is going to lead this program one day—what would you say to him?"
            },
            {
                title: "Reflection Complete",
            text: "You've finished the reflection. Below is a complete summary of your answers. You can read them over, copy them, download them, or generate an AI-powered action plan based on your reflection." // Updated text
            }
        ];

        // --- APPLICATION STATE ---
        let currentStep = 0;
        let allAnswers = new Array(script.length).fill("");
        let recognition;
        let isListening = false;
        let utterance;
        let speechVoices = [];

        // --- DOM ELEMENTS ---
        const appContainer = document.getElementById('app-container');
        const errorContainer = document.getElementById('error-container');

        // --- SPEECH API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synthesis = window.speechSynthesis;

        // Function to load and set voices
        function loadVoices() {
            if (synthesis) {
                speechVoices = synthesis.getVoices();
            }
            // You can add logic here to select a specific voice if you want
            // For now, it will use the default or the first available
        }

        // Function to speak text
        function speak(text) {
            if (!synthesis || !synthesis.speaking) {
                return;
            }
            synthesis.cancel();

            // Ensure text is valid
            if (!text || text.trim() === "") {
                console.warn("Speak function called with empty text.");
                return;
            }
            
            // Re-check voices if they haven't loaded yet
            if (speechVoices.length === 0) {
                loadVoices();
            }

            utterance = new SpeechSynthesisUtterance(text);
            
            // Try to find a good quality English voice
            let preferredVoice = 
                speechVoices.find(voice => voice.name.includes('Google') && voice.lang.includes('en')) ||
                speechVoices.find(voice => voice.name.includes('Microsoft') && voice.lang.includes('en')) ||
                speechVoices.find(voice => voice.lang.includes('en-US') || voice.lang.includes('en-GB'));

            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.onerror = (event) => {
                // Log the specific error, not the whole event
                console.error("SpeechSynthesis Error:", event.error);
            };
            
            // Give the 'cancel' a moment to finish before speaking again
            // This is a common fix for synthesis errors
            setTimeout(() => {
                synthesis.speak(utterance);
            }, 50); // 50ms delay
        }

        // Function to initialize speech recognition
        function initializeRecognition() {
            if (!SpeechRecognition) return; // Don't initialize if not supported
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening
            recognition.interimResults = true; // Show results as they come in
            recognition.lang = 'en-US';

            let interimTranscript = '';
            let finalTranscript = '';

            recognition.onstart = () => {
                isListening = true;
                updateRecordButton(true);
                finalTranscript = document.getElementById('transcript-textarea').value;
                if (finalTranscript.length > 0 && !finalTranscript.endsWith(' ')) {
                    finalTranscript += ' ';
                }
            };

            recognition.onresult = (event) => {
                interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                document.getElementById('transcript-textarea').value = finalTranscript + interimTranscript;
            };

            recognition.onend = () => {
                isListening = false;
                updateRecordButton(false);
                // Save the final answer
                allAnswers[currentStep] = document.getElementById('transcript-textarea').value;
            };

            recognition.onerror = (event) => {
                // Log the specific error, not the whole event
                console.error("SpeechRecognition Error:", event.error);
                isListening = false;
                updateRecordButton(false);
            };
        }

        // --- UI RENDERING ---

        /**
         * Renders the current state of the app (Start, Question, or Summary)
         */
        function renderApp() {
            // if (synthesis && synthesis.speaking) {
            //     synthesis.cancel(); // Stop any speech when changing steps
            // }

            if (currentStep === 0) {
                renderStartScreen();
            } else if (currentStep < script.length - 1) {
                renderQuestionScreen();
            } else {
                renderSummaryScreen();
            }
        }

        /**
         * Renders the initial welcome screen
         */
        function renderStartScreen() {
            const step = script[0];
            appContainer.innerHTML = `
                <div class="bg-gray-800 p-8 md:p-12 rounded-lg shadow-xl text-center">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-400 mb-4">${step.title}</h1>
                    <p class="text-lg text-gray-300 mb-8">${step.text}</p>
                    <button id="start-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition-all duration-200 shadow-lg">
                        Start Reflection
                    </button>
                </div>
            `;
            document.getElementById('start-button').addEventListener('click', handleNextStep);
            
            // Speak the welcome message
            // speak(step.text);
        }

        /**
         * Renders the main question interface
         */
        function renderQuestionScreen() {
            const step = script[currentStep];
            appContainer.innerHTML = `
                <div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl">
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                        <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${((currentStep) / (script.length - 2)) * 100}%"></div>
                    </div>
                
                    <!-- Question Title -->
                    <h2 class="text-2xl md:text-3xl font-bold text-blue-300 mb-3">${step.title}</h2>
                    
                    <!-- Question Text -->
                    <p class="text-base md:text-lg text-gray-300 mb-6" id="question-text">${step.text}</p>
                    
                    <!-- Record Button -->
                    <div class="flex flex-col items-center mb-4">
                        <button id="record-button" class="flex items-center justify-center w-20 h-20 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all duration-200 shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-400 focus:ring-opacity-50">
                            <!-- Mic Icon SVG -->
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zM10 15a5 5 0 005-5h-1.5a3.5 3.5 0 11-7 0H5a5 5 0 005 5z"></path>
                            </svg>
                        </button>
                        <span id="listening-indicator" class="text-red-400 mt-2 h-4 text-sm font-semibold"></span>
                    </div>
                    
                    <!-- Transcript Textarea -->
                    <textarea id="transcript-textarea" class="w-full h-48 bg-gray-900 border border-gray-700 rounded-lg p-4 text-white text-base resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your spoken response will appear here...">${allAnswers[currentStep]}</textarea>
                    
                    <!-- Navigation Buttons -->
                    <div class="flex justify-between mt-6">
                        <button id="prev-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200">
                            Previous
                        </button>
                        <button id="next-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200">
                            Next
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('record-button').addEventListener('click', toggleListening);
            document.getElementById('prev-button').addEventListener('click', handlePrevStep);
            document.getElementById('next-button').addEventListener('click', handleNextStep);
            
            // Save answer on manual text input
            document.getElementById('transcript-textarea').addEventListener('input', (e) => {
                allAnswers[currentStep] = e.target.value;
            });
            
            // Speak the question
            // speak(step.text);
        }

        /**
         * Renders the final summary screen
         */
        function renderSummaryScreen() {
            const step = script[currentStep];
            let summaryHtml = '';
            
            // Build the summary, skipping the intro
            for (let i = 1; i < script.length - 1; i++) {
                summaryHtml += `
                    <div class="bg-gray-800 p-4 rounded-lg mb-4 shadow-md">
                        <h3 class="text-xl font-semibold text-blue-300 mb-2">${script[i].title}</h3>
                        <p class="text-gray-300 whitespace-pre-wrap">${allAnswers[i] || "No answer recorded."}</p>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-400 mb-4">${step.title}</h1>
                    <p class="text-lg text-gray-300 mb-6">${step.text}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button id="copy-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-200 shadow-lg">
                            Copy Answers
                        </button>
                        <button id="download-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-200 shadow-lg">
                            Download as .txt
                        </button>
                        <button id="gemini-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-200 shadow-lg flex items-center justify-center gap-2">
                            ✨ Generate Action Plan
                        </button>
                    </div>
                    
                    <!-- Gemini AI Output Container -->
                    <div id="gemini-container" class="mt-6">
                        <!-- AI-generated content will be injected here -->
                    </div>
                    
                    <div id="summary-content" class="max-h-[50vh] overflow-y-auto pr-2 mt-6">
                        ${summaryHtml}
                    </div>
                    
                    <div class="flex justify-start mt-8">
                        <button id="prev-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200">
                            Back to Last Question
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('prev-button').addEventListener('click', handlePrevStep);
            document.getElementById('copy-button').addEventListener('click', copySummaryToClipboard);
            document.getElementById('download-button').addEventListener('click', downloadSummaryAsFile); // Added listener
            document.getElementById('gemini-button').addEventListener('click', handleGeminiActionPlan); // Added Gemini listener
            
            // Speak the final message
            // speak(step.text);
        }

        // --- EVENT HANDLERS ---

        function toggleListening() {
            if (!recognition) {
                console.warn("Recognition not initialized.");
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function handleNextStep() {
            if (currentStep < script.length - 1) {
                currentStep++;
                renderApp();
            }
        }

        function handlePrevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderApp();
            }
        }
        
        function updateRecordButton(listening) {
            const button = document.getElementById('record-button');
            const indicator = document.getElementById('listening-indicator');
            if (button) {
                if (listening) {
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-red-600', 'is-listening');
                    indicator.textContent = 'Listening...';
                } else {
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.remove('bg-red-600', 'is-listening');
                    indicator.textContent = '';
                }
            }
        }

        function getSummaryText() {
            let summaryText = `THE LOCKER ROOM REFLECTION\n============================\n\n`;
            for (let i = 1; i < script.length - 1; i++) {
                summaryText += `## ${script[i].title}\n\n`;
                summaryText += `${allAnswers[i] || "No answer recorded."}\n\n`;
                summaryText += `----------------------------\n\n`;
            }
            return summaryText;
        }

        function copySummaryToClipboard() {
            const summaryText = getSummaryText();

            // Use the clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(summaryText).then(() => {
                    document.getElementById('copy-button').textContent = 'Copied!';
                    setTimeout(() => {
                         document.getElementById('copy-button').textContent = 'Copy All Answers';
                    }, 2000);
                }).catch(err => {
                    console.warn('Clipboard API failed, falling back to execCommand.', err);
                    fallbackCopyTextToClipboard(summaryText);
                });
            } else {
                console.warn('Clipboard API not available, falling back to execCommand.');
                fallbackCopyTextToClipboard(summaryText);
            }
        }
        
        // Fallback for copying to clipboard for insecure contexts or older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'Copied!' : 'Copy Failed';
                document.getElementById('copy-button').textContent = msg;
            } catch (err) {
                document.getElementById('copy-button').textContent = 'Copy Failed';
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
            
            setTimeout(() => {
                 document.getElementById('copy-button').textContent = 'Copy All Answers';
            }, 2000);
        }

        /**
         * Creates and triggers a download for a text file summary
         */
        function downloadSummaryAsFile() {
            const summaryText = getSummaryText();
            const blob = new Blob([summaryText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            // Create a dynamic filename, e.g., Reflection-2025-11-14.txt
            const date = new Date();
            const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const filename = `Locker_Room_Reflection_${dateString}.txt`;
            
            link.setAttribute('download', filename);
            link.style.display = 'none';
            document.body.appendChild(link);
            
            link.click();
            
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up the object URL
        }


        // --- GEMINI API INTEGRATION ---

        /**
         * Exponential backoff for API retries
         */
        async function fetchWithBackoff(apiUrl, payload, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    console.error("API request failed with status:", response.status);
                    // Do not retry on client errors, only server errors
                    if (response.status >= 400 && response.status < 500) {
                        return null; // Failed request
                    }
                } catch (error) {
                    console.error("API request failed:", error.message);
                }
                // Wait for the delay and increase it for the next retry
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
            return null; // Exhausted retries
        }

        /**
         * Handles the "Generate Action Plan" button click
         */
        async function handleGeminiActionPlan() {
            const geminiContainer = document.getElementById('gemini-container');
            const geminiButton = document.getElementById('gemini-button');

            // Set loading state
            geminiContainer.innerHTML = `
                <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
                    <p class="text-center text-lg text-purple-300 animate-pulse">✨ Generating your personalized action plan... Please wait.</p>
                </div>
            `;
            geminiButton.disabled = true;
            geminiButton.classList.add('opacity-50', 'cursor-not-allowed');

            // 1. Define the System Prompt
            const systemPrompt = `You are an encouraging and insightful high-performance sports psychologist and rugby coach. An athlete has just completed a deep self-reflection. Their answers are provided below.

Your task is to synthesize all of their answers and create a short, positive, and actionable plan with 3-5 bullet points. This plan should help them bridge the gap between their 'current self' and their 'future self'.

Focus on their stated Strength (from Q4), their Shadow Side (from Q5), and their Future Self (from Q8). Do not just repeat their answers; provide concrete, new suggestions based on what they've told you. Keep the entire response under 200 words. Start with a brief encouraging opening, then provide the bullet points.`;

            // 2. Format the User's Answers as the User Query
            let userQuery = "Here are my reflection answers:\n\n";
            for (let i = 1; i < script.length - 1; i++) {
                userQuery += `Q: ${script[i].title}\n`;
                userQuery += `A: ${allAnswers[i] || "No answer provided."}\n\n`;
            }

            // 3. Set up API call
            const apiKey = ""; // Leave empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // 4. Call the API with backoff
            try {
                const result = await fetchWithBackoff(apiUrl, payload);

                if (result && result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    
                    // 5. Render the successful response
                    geminiContainer.innerHTML = `
                        <div class="bg-gray-700 p-6 rounded-lg shadow-inner border border-purple-400">
                            <h3 class="text-2xl font-bold text-purple-300 mb-4">✨ Your Personalized Action Plan</h3>
                            <div class="text-gray-200 text-lg whitespace-pre-wrap">${generatedText.replace(/•/g, '• ')}</div>
                        </div>
                    `;
                } else {
                    throw new Error("Invalid response from API.");
                }
            } catch (error) {
                console.error("Gemini API error:", error);
                // 5. Render an error message
                geminiContainer.innerHTML = `
                    <div class="bg-red-900 p-4 rounded-lg shadow-inner border border-red-400">
                        <p class="text-center text-lg text-red-200">Sorry, we couldn't generate your action plan at this time. Please try again later.</p>
                    </div>
                `;
            } finally {
                // 6. Restore the button
                geminiButton.disabled = false;
                geminiButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            // Check for browser compatibility
            if (!SpeechRecognition /* || !synthesis */) { // Removed synthesis check
                errorContainer.style.display = 'block';
                appContainer.style.display = 'none';
                console.error("Speech Recognition not supported in this browser.");
                return;
            }
            
            // Show the app
            errorContainer.style.display = 'none';
            appContainer.style.display = 'block';

            // Load voices
            // loadVoices(); // DISABLED
            // Voices may load asynchronously
            if (synthesis && synthesis.onvoiceschanged !== undefined) { // Check if synthesis exists
                // synthesis.onvoiceschanged = loadVoices; // DISABLED
            }

            // Initialize recognition
            initializeRecognition();
            
            // Render the first screen
            renderApp();
        });
    </script>
</body>
</html>
